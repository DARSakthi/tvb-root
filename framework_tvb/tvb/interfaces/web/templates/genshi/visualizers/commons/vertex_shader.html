<script id="shader-vs" type="x-shader/x-vertex" xmlns:py="http://genshi.edgewall.org/">
    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;

    uniform vec2 activityRange;
    <py:choose test="">
        <py:when test="isOneToOneMapping">
            attribute float aActivity;
            uniform float uColorScheme;
        </py:when>
        <py:otherwise>
            attribute vec3 alphaIndices;
            attribute vec2 alpha;

            uniform vec2 uActivity[${abs(noOfMeasurePoints) + 2} + 127];
        </py:otherwise>
    </py:choose>

    uniform mat4 uPMatrix;
    uniform mat4 uMVMatrix;
    uniform mat4 uNMatrix;

    uniform vec3 uAmbientColor;
    uniform vec3 uLightingDirection;
    uniform vec3 uDirectionalColor;
    uniform vec3 uLinesColor;

    uniform float uMaterialShininess;
    uniform vec3 uPointLightingLocation;
    uniform vec3 uPointLightingSpecularColor;

    // these are used to draw whole objects in a specific color ignoring vertex attributes.
    uniform bool uUseVertexColors;
    uniform vec4 uMaterialColor;

    uniform sampler2D uSampler;

    varying vec4 vColor;

    void main(void) {

        vec4 mvPosition = uMVMatrix * vec4(aVertexPosition, 1.0);
        vec4 transformedNormal = uNMatrix * vec4(aVertexNormal, 1.0);
        vec3 normal = normalize(transformedNormal.xyz);

        vec3 lightDirection = normalize(uPointLightingLocation - aVertexPosition.xyz);
        vec3 reflectionDirection = reflect(-lightDirection, normal);
        vec3 eyeDirection = normalize(-aVertexPosition.xyz);

        float directionalLightWeighting = max(dot(normal, uLightingDirection), 0.0);
        float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uMaterialShininess);

        gl_Position = uPMatrix * mvPosition;

        vec4 materialColor;

        if (uUseVertexColors){
        <py:choose test="">
            <py:when test="isOneToOneMapping">
                vec2 uv = vec2(aActivity, uColorScheme);
            </py:when>
            <py:otherwise>
                vec2 uv = uActivity[int(alphaIndices[0])] * alpha[0] + uActivity[int(alphaIndices[1])] * alpha[1] +
                     uActivity[int(alphaIndices[2])] * (1.0 - alpha[0] - alpha[1]);
            </py:otherwise>
        </py:choose>
            uv[0] = (uv[0] - activityRange[0] ) / (activityRange[1] - activityRange[0]);
            materialColor = texture2D(uSampler, uv);
        } else {
            materialColor = uMaterialColor;
        }

        vec3 diffuse = uAmbientColor + uDirectionalColor * directionalLightWeighting;
        vec3 light = materialColor.rgb * diffuse + uPointLightingSpecularColor * specularLightWeighting;
        vColor = vec4(light, materialColor.a);
    }
</script>