<script id="shader-vs" type="x-shader/x-vertex" xmlns:py="http://genshi.edgewall.org/">
    attribute vec3 aVertexPosition;
    attribute vec3 aVertexNormal;

    <py:choose test="">
        <py:when test="isOneToOneMapping">
            attribute vec4 aVertexColor;
        </py:when>
        <py:otherwise>
            attribute vec3 alphaIndices;
            attribute vec2 alpha;

            uniform vec4 uVertexColors[${abs(noOfMeasurePoints) + 2} + 127];
        </py:otherwise>
    </py:choose>

    uniform mat4 uPMatrix;
    uniform mat4 uMVMatrix;
    uniform mat4 uNMatrix;
    uniform vec3 uAmbientColor;
    uniform vec3 uLightingDirection;
    uniform vec3 uDirectionalColor;
    uniform vec3 uLinesColor;

    uniform bool uUseBlending;
    uniform bool uDrawLines;
    uniform bool uUseVertexLineColor;

    uniform float uMaterialShininess;
    uniform vec3 uPointLightingLocation;
    uniform vec3 uPointLightingSpecularColor;

    uniform float isPicking;
    uniform vec3 pickingColor;

    varying vec4 vColor;

    void main(void) {

        vec4 mvPosition = uMVMatrix * vec4(aVertexPosition, 1.0);
        vec4 transformedNormal = uNMatrix * vec4(aVertexNormal, 1.0);
        vec3 normal = normalize(transformedNormal.xyz);

        vec3 lightDirection = normalize(uPointLightingLocation - aVertexPosition.xyz);
        vec3 reflectionDirection = reflect(-lightDirection, normal);
        vec3 eyeDirection = normalize(-aVertexPosition.xyz);

        float directionalLightWeighting = max(dot(normal, uLightingDirection), 0.0);
        float specularLightWeighting = pow(max(dot(reflectionDirection, eyeDirection), 0.0), uMaterialShininess);

        gl_Position = uPMatrix * mvPosition;

        vec3 ambientColor = uAmbientColor;
        vec3 difuseColor = uDirectionalColor;
        vec3 specularColor = uPointLightingSpecularColor;
        vec4 materialColor;

        <py:choose test="">
            <py:when test="isOneToOneMapping">
                materialColor = aVertexColor;
            </py:when>
            <py:otherwise>
                materialColor = uVertexColors[int(alphaIndices[0])] * alpha[0] + uVertexColors[int(alphaIndices[1])] * alpha[1] +
                     uVertexColors[int(alphaIndices[2])] * (1.0 - alpha[0] - alpha[1]);
            </py:otherwise>
        </py:choose>

        if (isPicking == 0.0) {
            if (uUseVertexLineColor || !uDrawLines) {
                if (uUseBlending) {
                    ambientColor = vec3(0.4, 0.4, 0.4);
                    difuseColor = vec3(0.4, 0.4, 0.4);
                    specularColor = vec3(0.0, 0.0, 0.0);
                    materialColor = vec4(0.95, 0.95, 0.95, 0.29);
                }
            } else {
                if (uDrawLines) {
                    ambientColor = vec3(0.2, 0.2, 0.2);
                    difuseColor = vec3(0.1, 0.1, 0.1);
                    specularColor = vec3(0.0, 0.0, 0.0);
					materialColor = vec4(uLinesColor, 1.0);
                }
            }
        } else {
            ambientColor = vec3(1.0, 1.0, 1.0);
            difuseColor = vec3(0.0, 0.0, 0.0);
            specularColor = vec3(0.0, 0.0, 0.0);
            materialColor = vec4(pickingColor, 1.0);
        }

        vec3 light = materialColor.rgb * ( ambientColor + difuseColor * directionalLightWeighting + specularColor * specularLightWeighting);
        vColor = vec4(light, materialColor.a);
    }
</script>