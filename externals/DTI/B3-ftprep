#!/bin/sh
## --- 8/14/2011 --- ##

## PURPOSE ##

## NOTES ##
# run after mni2dti

#=======================================================================================

### PREP SCRIPT ###

## check arguments ##
if [ ${#} -ne 1 ]; then 
  echo ""
  echo " Error: Must supply subject pfx as first argument"; 
  echo ""
  exit
fi

## change into subject's directory ##
pfx=${1}
if [ ! -d ${pfx} ]; then echo "Error: \"${pfx}\" directory does not exist"; exit; fi
cd ${pfx}

#=======================================================================================

### ===> VARIABLES <=== ###

# Note:  The values below will probably remain fixed for the virtual brain project
# but some studies could conceivably need to modify them.

## number of iterations to allow before terminating search for nearest cocomac label ##
interfaceSearchIterations=2

## minimum angle threshold for adding edges to wm graph ##
## (should preserve 10-12.5 degree / 1 mm voxel ratio) ##
xsize=`fslinfo ${pfx}_DTI_ec.img | grep "^pixdim1" | sed "s/pixdim1 *//"`
ysize=`fslinfo ${pfx}_DTI_ec.img  | grep "^pixdim2" | sed "s/pixdim2 *//"`
zsize=`fslinfo ${pfx}_DTI_ec.img  | grep "^pixdim3" | sed "s/pixdim3 *//"`
min=${xsize}
if [ `echo "${ysize} < ${min}" |bc` = 1 ]; then min=${ysize}; fi
if [ `echo "${zsize} < ${min}" |bc` = 1 ]; then min=${zsize}; fi
minimumAngleThreshold=`echo "${min} * 12" | bc | xargs printf "%1.0f"`
# sunnybrook = 37 degrees (2.96 mm)
# berlin = 28 degrees (2.29 mm)

#=======================================================================================

### PROCESSSING INTERFACE IMAGES ###

## Convert mni2dti output to 16 bit (from 32 bit)  ##
imgmath ${pfx}_seg_to_dti.img -thr 0 ${pfx}_seg_to_dti.img -short
imgmath ${pfx}_cocomac_cortical_to_dti.img -thr 0 ${pfx}_cocomac_cortical_to_dti.img -short
imgmath ${pfx}_subcortical_to_dti.img -thr 0 ${pfx}_subcortical_to_dti.img -short
imgmath ${pfx}_t1_to_dti.img -thr 0 ${pfx}_t1_to_dti.img -short
imgmath ${pfx}_cocomac_cortical_to_t1.img -thr 0 ${pfx}_cocomac_cortical_to_t1.img -short
imgmath ${pfx}_mnim_to_t1.img -thr 0 ${pfx}_mnim_to_t1.img -short
imgmath ${pfx}_mni_to_t1.img -thr 0 ${pfx}_mni_to_t1.img -short
imgmath ${pfx}_subcortical_to_t1.img -thr 0 ${pfx}_subcortical_to_t1.img -short
imgmath ${pfx}_mnicm_to_dti.img -thr 0 ${pfx}_mnicm_to_dti.img -short
imgmath ${pfx}_mniscm_to_dti.img -thr 0 ${pfx}_mniscm_to_dti.img -short
imgmath ${pfx}_rightm_to_dti.img -thr 0 ${pfx}_rightm_to_dti.img -short
imgmath ${pfx}_leftm_to_dti.img -thr 0 ${pfx}_leftm_to_dti.img -short

## Find White-Grey Interface ##
GetWhiteGreyInterface ${pfx}_seg_to_dti.img 3 4 ${pfx}_dti_wmgm_interface.img

## Label White-Grey Interface  ##
GetLabelsForWhiteGreyInterface ${pfx}_dti_wmgm_interface.img ${pfx}_cocomac_cortical_to_dti.img ${pfx}_dti_wmgm_interface_labelled.img ${interfaceSearchIterations}

#=======================================================================================

### PROCESSSING CORTICO-CORTICAL CONNECTIVITY ###

## get white matter mask from T1 seg (wm = 3)  ##
mask_img ${pfx}_seg_to_dti ${pfx}_seg_to_dti -o ${pfx}_seg_to_dti_wmonly -m 0 4 5 6 7 

## remove brainstem/cerebellar white matter voxels using cortical mask (mnicm) ##
mask_img ${pfx}_seg_to_dti_wmonly ${pfx}_mnicm_to_dti -o ${pfx}_seg_to_dti_wmonly_cm -m 0

## isolate right hemisphere ##
mask_img ${pfx}_seg_to_dti_wmonly_cm ${pfx}_rightm_to_dti -o ${pfx}_seg_to_dti_wmonly_cm_rightonly -m 0

## isolate left hemisphere ##
mask_img ${pfx}_seg_to_dti_wmonly_cm ${pfx}_leftm_to_dti -o ${pfx}_seg_to_dti_wmonly_cm_leftonly -m 0

## get eigenvector filenames ##
ev11=`ls ${pfx}_*ev1_1.img`
ev12=`ls ${pfx}_*ev1_2.img`
ev13=`ls ${pfx}_*ev1_3.img`

## remove non-fiber tracking voxels from eigenvector images ##
imgmath ${ev11} -mas ${pfx}_seg_to_dti_wmonly_cm.img ${pfx}_primaryEV_wmonly_cm_0000.nii
imgmath ${ev12} -mas ${pfx}_seg_to_dti_wmonly_cm.img ${pfx}_primaryEV_wmonly_cm_0001.nii
imgmath ${ev13} -mas ${pfx}_seg_to_dti_wmonly_cm.img ${pfx}_primaryEV_wmonly_cm_0002.nii

## repeat for right hemisphere ##
imgmath ${pfx}_primaryEV_wmonly_cm_0000.nii -mas ${pfx}_seg_to_dti_wmonly_cm_rightonly.img ${pfx}_primaryEV_wmonly_cm_rightonly_0000.nii
imgmath ${pfx}_primaryEV_wmonly_cm_0001.nii -mas ${pfx}_seg_to_dti_wmonly_cm_rightonly.img ${pfx}_primaryEV_wmonly_cm_rightonly_0001.nii
imgmath ${pfx}_primaryEV_wmonly_cm_0002.nii -mas ${pfx}_seg_to_dti_wmonly_cm_rightonly.img ${pfx}_primaryEV_wmonly_cm_rightonly_0002.nii

## repeat for left hemisphere ##
imgmath ${pfx}_primaryEV_wmonly_cm_0000.nii -mas ${pfx}_seg_to_dti_wmonly_cm_leftonly.img ${pfx}_primaryEV_wmonly_cm_leftonly_0000.nii
imgmath ${pfx}_primaryEV_wmonly_cm_0001.nii -mas ${pfx}_seg_to_dti_wmonly_cm_leftonly.img ${pfx}_primaryEV_wmonly_cm_leftonly_0001.nii
imgmath ${pfx}_primaryEV_wmonly_cm_0002.nii -mas ${pfx}_seg_to_dti_wmonly_cm_leftonly.img ${pfx}_primaryEV_wmonly_cm_leftonly_0002.nii

## construct white matter graph for cortico-cortical connectivity  ## 
WhiteMatterGraph ${pfx}_primaryEV_wmonly_cm_0000.nii ${pfx}_primaryEV_wmonly_cm_0001.nii ${pfx}_primaryEV_wmonly_cm_0002.nii ${minimumAngleThreshold} ${pfx}_dti_graph_wmonly_cm_plusNNN_${minimumAngleThreshold}deg.txt

## repeat for right hemisphere ##
WhiteMatterGraph ${pfx}_primaryEV_wmonly_cm_rightonly_0000.nii ${pfx}_primaryEV_wmonly_cm_rightonly_0001.nii ${pfx}_primaryEV_wmonly_cm_rightonly_0002.nii ${minimumAngleThreshold} ${pfx}_dti_graph_wmonly_cm_rightonly_plusNNN_${minimumAngleThreshold}deg.txt

## repeat for left hemisphere ##
WhiteMatterGraph ${pfx}_primaryEV_wmonly_cm_leftonly_0000.nii ${pfx}_primaryEV_wmonly_cm_leftonly_0001.nii ${pfx}_primaryEV_wmonly_cm_leftonly_0002.nii ${minimumAngleThreshold} ${pfx}_dti_graph_wmonly_cm_leftonly_plusNNN_${minimumAngleThreshold}deg.txt


#=======================================================================================

### PROCESSSING CORTICAL-SUBCORTICAL CONNECTIVITY ###

## remove brainstem/cerebellar white matter voxels using subcortical mask (mniscm) ##
mask_img ${pfx}_seg_to_dti_wmonly ${pfx}_mniscm_to_dti -o ${pfx}_seg_to_dti_wmonly_scm -m 0

## isolate right hemisphere ##
mask_img ${pfx}_seg_to_dti_wmonly_scm ${pfx}_rightm_to_dti -o ${pfx}_seg_to_dti_wmonly_scm_rightonly -m 0

## isolate left hemisphere ##
mask_img ${pfx}_seg_to_dti_wmonly_scm ${pfx}_leftm_to_dti -o ${pfx}_seg_to_dti_wmonly_scm_leftonly -m 0

## remove any voxels that overlap in the interface and subcortical images ##
imgmath ${pfx}_dti_wmgm_interface_labelled.img -bin ${pfx}_dti_wmgm_interface_bin.img
mask_img ${pfx}_subcortical_to_dti ${pfx}_dti_wmgm_interface_bin -m 1
imgmath ${pfx}_subcortical_to_dti_masked.img -add ${pfx}_dti_wmgm_interface_labelled.img ${pfx}_dti_seed_regions.img -short
rm ${pfx}_dti_wmgm_interface_bin.*

## construct white matter graph for subcortical-cortical connectivity ##
# (Note:  One graph is created for each subcortical region.  The graph
#            includes wm and one subcortical region)

subcorticalCodes="51 52 53 61 62 63 64 151 152 153 161 162 163 164"

## for each subcortical region ##
for code in ${subcorticalCodes}
do
  
  ## remove the subcortical code from the maskingCodes variable ##
  maskingCodes=${subcorticalCodes}
  maskingCodes=`echo ${maskingCodes} | sed "s/${code}//"`

  code=`printf %03d ${code}`
  
  ## create a subcortical image containing only the subcortical region currently being processed ##
  mask_img ${pfx}_subcortical_to_dti ${pfx}_subcortical_to_dti -o ${pfx}_subcortical_to_dti_${code}only -m ${maskingCodes}
  
  ## if adding a thalamic roi, remove all other thalamic rois in the same hemispher ##
  maskThalamus="0";
  
  if [ ${code} -eq 51 ]; then
     maskThalamusRegions="52 53"
     maskThalamus="1"
  else if [ ${code} -eq 52 ]; then
    maskThalamusRegions="51 53"
    maskThalamus="1"
  else if [ ${code} -eq 53 ]; then
    maskThalamusRegions="51 52"
    maskThalamus="1"
  else if [ ${code} -eq 151 ]; then
    maskThalamusRegions="152 153"
    maskThalamus="1"
  else if [ ${code} -eq 152 ]; then
    maskThalamusRegions="151 153"
    maskThalamus="1"
  else if [ ${code} -eq 153 ]; then
    maskThalamusRegions="151 152"
    maskThalamus="1"
  fi; fi; fi; fi; fi; fi;
  
  ## testing (thalamic masking off) ##
  #maskThalamus="0"
 
 if [ ${maskThalamus} -eq 1  ]; then
    ## mask thalamic rois ##
    mask_img ${pfx}_seg_to_dti_wmonly_scm ${pfx}_subcortical_to_dti -m ${maskThalamusRegions}
    mask_img ${pfx}_seg_to_dti_wmonly_scm_rightonly ${pfx}_subcortical_to_dti -m ${maskThalamusRegions}
    mask_img ${pfx}_seg_to_dti_wmonly_scm_leftonly ${pfx}_subcortical_to_dti -m ${maskThalamusRegions}
  else
    ## null operation ##
    imgmath  ${pfx}_seg_to_dti_wmonly_scm.img -thr 0  ${pfx}_seg_to_dti_wmonly_scm_masked.img
    imgmath  ${pfx}_seg_to_dti_wmonly_scm_rightonly.img -thr 0  ${pfx}_seg_to_dti_wmonly_scm_rightonly_masked.img
    imgmath  ${pfx}_seg_to_dti_wmonly_scm_leftonly.img -thr 0  ${pfx}_seg_to_dti_wmonly_scm_leftonly_masked.img
   fi
  
  usescm=1;
  if [ ${code} -eq 61 ]; then
    usescm=0
  else if [ ${code} -eq 62 ]; then
    usescm=0
  else if [ ${code} -eq 63 ]; then
    usescm=0
  else if [ ${code} -eq 64 ]; then 
    usescm=0;
  else if [ ${code} -eq 161 ]; then
    usescm=0
  else if [ ${code} -eq 162 ]; then
    usescm=0
  else if [ ${code} -eq 163 ]; then
    usescm=0
  else if [ ${code} -eq 164 ]; then 
    usescm=0;
  fi; fi; fi; fi; fi; fi; fi; fi;
  
  if [ ${usescm} -eq 1 ]; then  ## thalamus
    ## add the subcortical region to the wm mask ##
    imgmath ${pfx}_subcortical_to_dti_${code}only.img -add ${pfx}_seg_to_dti_wmonly_scm_masked.img ${pfx}_seg_to_dti_wmonly_scm_plus${code}.img
    ## repeat for right hemisphere ##
    imgmath ${pfx}_subcortical_to_dti_${code}only.img -add ${pfx}_seg_to_dti_wmonly_scm_rightonly_masked.img ${pfx}_seg_to_dti_wmonly_scm_rightonly_plus${code}.img
    ## repeat for left hemisphere ##
    imgmath ${pfx}_subcortical_to_dti_${code}only.img -add ${pfx}_seg_to_dti_wmonly_scm_leftonly_masked.img ${pfx}_seg_to_dti_wmonly_scm_leftonly_plus${code}.img
 else  ## basal ganglia -- use cm instead of scm (remove brainstem)
    ## add the subcortical region to the wm mask ##
    imgmath ${pfx}_subcortical_to_dti_${code}only.img -add ${pfx}_seg_to_dti_wmonly_cm.img ${pfx}_seg_to_dti_wmonly_scm_plus${code}.img
    ## repeat for right hemisphere ##
    imgmath ${pfx}_subcortical_to_dti_${code}only.img -add ${pfx}_seg_to_dti_wmonly_cm_rightonly.img ${pfx}_seg_to_dti_wmonly_scm_rightonly_plus${code}.img
    ## repeat for left hemisphere ##
    imgmath ${pfx}_subcortical_to_dti_${code}only.img -add ${pfx}_seg_to_dti_wmonly_cm_leftonly.img ${pfx}_seg_to_dti_wmonly_scm_leftonly_plus${code}.img
 fi
  ## remove voxels that are not white matter or the subcortical region currently being processed from the eigenvector image ##
  imgmath ${ev11} -mas ${pfx}_seg_to_dti_wmonly_scm_plus${code}.img ${pfx}_primaryEV_wmonly_scm_plus${code}_0000.nii
  imgmath ${ev12} -mas ${pfx}_seg_to_dti_wmonly_scm_plus${code}.img ${pfx}_primaryEV_wmonly_scm_plus${code}_0001.nii
  imgmath ${ev13} -mas ${pfx}_seg_to_dti_wmonly_scm_plus${code}.img ${pfx}_primaryEV_wmonly_scm_plus${code}_0002.nii

  ## repeat for right hemisphere ##
  imgmath ${pfx}_primaryEV_wmonly_scm_plus${code}_0000.nii -mas ${pfx}_seg_to_dti_wmonly_scm_rightonly_plus${code}.img ${pfx}_primaryEV_wmonly_scm_rightonly_plus${code}_0000.nii
  imgmath ${pfx}_primaryEV_wmonly_scm_plus${code}_0001.nii -mas ${pfx}_seg_to_dti_wmonly_scm_rightonly_plus${code}.img ${pfx}_primaryEV_wmonly_scm_rightonly_plus${code}_0001.nii
  imgmath ${pfx}_primaryEV_wmonly_scm_plus${code}_0002.nii -mas ${pfx}_seg_to_dti_wmonly_scm_rightonly_plus${code}.img ${pfx}_primaryEV_wmonly_scm_rightonly_plus${code}_0002.nii

  ## repeate for left hemisphere ##
  imgmath ${pfx}_primaryEV_wmonly_scm_plus${code}_0000.nii -mas ${pfx}_seg_to_dti_wmonly_scm_leftonly_plus${code}.img ${pfx}_primaryEV_wmonly_scm_leftonly_plus${code}_0000.nii
  imgmath ${pfx}_primaryEV_wmonly_scm_plus${code}_0001.nii -mas ${pfx}_seg_to_dti_wmonly_scm_leftonly_plus${code}.img ${pfx}_primaryEV_wmonly_scm_leftonly_plus${code}_0001.nii
  imgmath ${pfx}_primaryEV_wmonly_scm_plus${code}_0002.nii -mas ${pfx}_seg_to_dti_wmonly_scm_leftonly_plus${code}.img ${pfx}_primaryEV_wmonly_scm_leftonly_plus${code}_0002.nii
 
  ## construct the white matter graph including the subcortical region currently being processed ##
  WhiteMatterGraph ${pfx}_primaryEV_wmonly_scm_plus${code}_0000.nii ${pfx}_primaryEV_wmonly_scm_plus${code}_0001.nii ${pfx}_primaryEV_wmonly_scm_plus${code}_0002.nii ${minimumAngleThreshold} ${pfx}_dti_graph_wmonly_scm_plus${code}_${minimumAngleThreshold}deg.txt

  ## repeat for right hemisphere ##
  WhiteMatterGraph ${pfx}_primaryEV_wmonly_scm_rightonly_plus${code}_0000.nii ${pfx}_primaryEV_wmonly_scm_rightonly_plus${code}_0001.nii ${pfx}_primaryEV_wmonly_scm_rightonly_plus${code}_0002.nii ${minimumAngleThreshold} ${pfx}_dti_graph_wmonly_scm_rightonly_plus${code}_${minimumAngleThreshold}deg.txt

  ## repeat for left hemisphere ##
  WhiteMatterGraph ${pfx}_primaryEV_wmonly_scm_leftonly_plus${code}_0000.nii ${pfx}_primaryEV_wmonly_scm_leftonly_plus${code}_0001.nii ${pfx}_primaryEV_wmonly_scm_leftonly_plus${code}_0002.nii ${minimumAngleThreshold} ${pfx}_dti_graph_wmonly_scm_leftonly_plus${code}_${minimumAngleThreshold}deg.txt

  ## clean-up  ##
  rm ${pfx}_subcortical_to_dti_${code}only.*
  rm ${pfx}_seg_to_dti_wmonly*cm*plus${code}.*
  rm ${pfx}_primaryEV_wmonly*cm*plus${code}_000[0-2].nii

done

## more clean-up ##
rm ${pfx}_*_wmonly*.[ihn]*
rm ${pfx}_subcortical_to_dti_masked.*
#=======================================================================================

cd ../
