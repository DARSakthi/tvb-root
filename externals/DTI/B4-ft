#!/bin/bash

## --- 8/14/2011 --- ##

## PURPOSE ##
# perform fiber tracking using region pairs specified in ft_* text files

## NOTES ##
# run after ftprep

#=======================================================================================

### PREP SCRIPT ###

## check arguments ##
if [ ${#} -ne 1 ]; then 
  echo ""
  echo " Error: Must supply subject pfx as first argument"; 
  echo ""
  exit
fi

## change into subjects's directory ##
pfx=${1}
if [ ! -d ${pfx} ]; then echo "Error: \"${pfx}\" directory does not exist"; exit; fi
cd ${pfx}

#=======================================================================================

### ===> VARIABLES <=== ###

mnidir="/home/erin/standard_brains"

#=======================================================================================

## PROCESSING FIBER TRACTS ##

## get all text files with region pairs ##
seeds=`ls ${mnidir}/ft_*`

## for each text file ##
for seed in ${seeds}
do

  echo $seed

  ## get source regions ##
  seeds1=`cut ${seed} -f1`
  
  ## get target regions ##
  seeds2=`cut ${seed} -f2`

  ## convert to matrix ##
  seeds1=( ${seeds1} )
  seeds2=( ${seeds2} )

  ## get tracking flag from the name of the text file ##
  region=`echo ${seed} | sed "s/.*_cortical_//" | sed "s/\.txt//"`
  
  ## get the subject's corresponding white matter graph ##
  graphboth=`ls *m_plus${region}*`
  graphleft=`ls *leftonly_plus${region}*`
  graphright=`ls *rightonly_plus${region}*`
 
  ## perform fiber tracking for each source-target region pair ##
  index=0
  while [ ${index} -lt ${#seeds1[@]} ] 
  do

    ## format source and target identifiers ##
    seed1=${seeds1[${index}]}
    seed2=${seeds2[${index}]}
    seed1=`printf %03d ${seed1}`
    seed2=`printf %03d ${seed2}`
    echo ${seed1} ${seed2}
    
    graph=${graphboth};
    if [ ${seed1} -le 100 ]; then
      if [ ${seed2} -le 100 ]; then
        graph=${graphright};
      fi
    fi
    if [ ${seed1} -gt 100 ]; then
      if [ ${seed2} -gt 100 ]; then
          graph=${graphleft};
      fi
    fi
    
    ## perform fiber tracking ##    
    OrderPathsShortestToLongest ${graph} ${pfx}_dti_seed_regions.img ${seed1} ${seed2} -1 ${pfx}
   
   
 
    index=`expr ${index} + 1`
  
  done # end region pairs

done # end text files

#=======================================================================================

cd ../
